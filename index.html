<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crispy Chicken - Sales Analytics & Targets</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary-color: #b30000;
    --primary-dark: #8a0000;
    --secondary-color: #e63946;
    --dark-color: #1d3557;
    --success-color: #2a9d8f;
    --warning-color: #e9c46a;
    --danger-color: #e76f51;
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh; color: #333; padding-bottom: 40px;
}

.container { max-width: 1800px; margin: 0 auto; padding: 20px; }

/* Header */
header {
    background: white; padding: 20px 30px; border-radius: var(--border-radius);
    margin-bottom: 25px; box-shadow: var(--shadow-lg);
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    border-bottom: 4px solid var(--primary-color);
}

h1 { color: var(--primary-color); font-size: 1.8rem; display: flex; align-items: center; gap: 12px; }
.header-actions { display: flex; gap: 10px; align-items: center; }
.date-display { color: var(--dark-color); font-weight: 500; background: #f0f2f5; padding: 8px 15px; border-radius: 20px; font-size: 0.95rem; }

/* Buttons */
button {
    padding: 10px 18px; background: var(--primary-color); color: white;
    border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
    transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
}
button:hover { background: var(--primary-dark); transform: translateY(-2px); }
button.secondary { background: var(--dark-color); }
button.success { background: var(--success-color); }
button.danger { background: var(--danger-color); }
button.outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
button.outline:hover { background: var(--primary-color); color: white; }

/* Layout */
.dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; margin-bottom: 25px; }

/* KPI Cards */
.kpi-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
.kpi-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); position: relative; }
.kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.kpi-title { font-size: 0.85rem; color: #6b7280; font-weight: 600; text-transform: uppercase; }
.kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--dark-color); margin: 10px 0; }
.kpi-sub { font-size: 0.85rem; color: #888; }
.kpi-icon { position: absolute; right: 20px; top: 20px; opacity: 0.1; font-size: 3rem; color: var(--primary-color); }

/* Special styling for the aggregate Call Center card */
.kpi-card.aggregate { border: 2px solid var(--warning-color); background: #fffdf5; }
.kpi-card.aggregate .kpi-icon { color: var(--warning-color); }

/* Charts */
.charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
.chart-card { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
h2 { font-size: 1.2rem; color: var(--dark-color); display: flex; align-items: center; gap: 10px; }
.chart-container { position: relative; height: 300px; width: 100%; }

/* Forms */
.data-entry-panel { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); height: fit-content; }
.data-list-panel { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
.form-group { margin-bottom: 15px; }
label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--dark-color); font-size: 0.9rem; }
input, select {
    width: 100%; padding: 10px 12px;
    border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;
    transition: var(--transition); background: #f9fafb;
}
input:focus, select:focus { border-color: var(--primary-color); background: white; outline: none; }
.input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }

/* Table */
.table-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
.data-table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb; }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th { background: var(--dark-color); color: white; padding: 14px 16px; text-align: left; }
td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
tr:hover { background: #f9fafb; }

/* Modal */
.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: flex; justify-content: center; align-items: center; z-index: 1000;
    opacity: 0; visibility: hidden; transition: var(--transition);
}
.modal.show { opacity: 1; visibility: visible; }
.modal-content {
    background: white; padding: 30px; border-radius: var(--border-radius);
    width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    transform: scale(0.95); transition: var(--transition);
}
.modal.show .modal-content { transform: scale(1); }

/* Toast */
.toast {
    position: fixed; bottom: 30px; right: 30px;
    background: var(--dark-color); color: white;
    padding: 15px 25px; border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    transform: translateY(100px); opacity: 0; transition: var(--transition); z-index: 2000;
}
.toast.show { transform: translateY(0); opacity: 1; }

@media (max-width: 1200px) {
    .dashboard-grid { grid-template-columns: 1fr; }
    .charts-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-drumstick-bite"></i> Crispy Chicken Analytics</h1>
        <div class="header-actions">
            <div class="date-display" id="currentDate"><i class="far fa-calendar-alt"></i> <span>--</span></div>
            <button class="outline" onclick="document.getElementById('csvInput').click()"><i class="fas fa-file-upload"></i> Import</button>
            <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="importSalesData(this)">
            <button class="secondary" onclick="exportSalesData()"><i class="fas fa-download"></i> Export</button>
            <button class="success" onclick="openModal()"><i class="fas fa-plus"></i> New Entry</button>
        </div>
    </header>

    <section class="kpi-section" id="kpiSection"></section>

    <section class="charts-row">
        <div class="chart-card">
            <div class="card-header">
                <h2><i class="fas fa-chart-area"></i> Sales Trend</h2>
                <select id="trendPeriod" onchange="updateDashboard()">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last Quarter</option>
                </select>
            </div>
            <div class="chart-container"><canvas id="salesTrendChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="card-header">
                <h2><i class="fas fa-chart-pie"></i> Channels</h2>
            </div>
            <div class="chart-container"><canvas id="distChart"></canvas></div>
        </div>
    </section>

    <main class="dashboard-grid">
        <!-- Quick Entry -->
        <aside class="data-entry-panel">
            <div class="card-header"><h2><i class="fas fa-edit"></i> Quick Entry</h2></div>
            <form id="quickForm" onsubmit="handleQuickSubmit(event)">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="q_branch" required onchange="autoFillTarget('q_branch', 'q_target')">
                        <option value="">Select Branch</option>
                        <option value="Crispy Chicken Hamdan">Hamdan</option>
                        <option value="Crispy Chicken Shabia">Shabia</option>
                        <option value="Crispy Chicken Khaldia">Khaldia</option>
                        <option value="Crispy Chicken Mourror">Mourror</option>
                        <option value="Crispy Chicken Barsha">Barsha</option>
                        <option value="Crispy Chicken Satwa">Satwa</option>
                        <option value="Crispy Chicken Electra">Electra</option>
                        <option value="Crispy Chicken Rigga">Rigga</option>
                        <option value="Crispy Chicken Majaz">Majaz</option>
                        <option value="Crispy Chicken Call Center">Call Center</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="q_date" required>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Delivery</label><input type="number" id="q_delivery" step="0.01" min="0" placeholder="0.00"></div>
                    <div class="form-group"><label>Online</label><input type="number" id="q_online" step="0.01" min="0" placeholder="0.00"></div>
                    <div class="form-group"><label>Aggregator</label><input type="number" id="q_aggregator" step="0.01" min="0" placeholder="0.00"></div>
                    <div class="form-group"><label>Dining</label><input type="number" id="q_dining" step="0.01" min="0" placeholder="0.00"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Transactions</label><input type="number" id="q_trans" min="0" placeholder="0"></div>
                    <div class="form-group"><label>Daily Target</label><input type="number" id="q_target" step="0.01" min="0" placeholder="Auto-filled"></div>
                </div>
                <button type="submit" class="success" style="width: 100%; justify-content: center;"><i class="fas fa-save"></i> Save Entry</button>
            </form>
        </aside>

        <!-- Table -->
        <section class="data-list-panel">
            <div class="card-header"><h2><i class="fas fa-table"></i> Transaction History</h2></div>
            <div class="table-controls">
                <div class="filter-group" style="flex:1; min-width:180px;">
                    <label>Filter Branch</label>
                    <select id="f_branch" onchange="updateDashboard()"><option value="all">All Branches</option></select>
                </div>
                <div class="filter-group" style="flex:1; min-width:150px;">
                    <label>Time Period</label>
                    <select id="f_period" onchange="updateDashboard()">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
            <div class="data-table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Branch</th>
                            <th>Total</th>
                            <th>Trans.</th>
                            <th>Achievement</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div id="emptyState" style="display:none; text-align: center; padding: 40px; color: #999;">
                <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <p>No records found.</p>
            </div>
        </section>
    </main>
</div>

<!-- Modal -->
<div class="modal" id="entryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Data</h2>
            <button class="outline" onclick="closeModal()" style="border:none; padding:5px;"><i class="fas fa-times"></i></button>
        </div>
        <form id="modalForm" onsubmit="handleModalSubmit(event)">
            <input type="hidden" id="m_id">
            <div class="form-group">
                <label>Branch *</label>
                <select id="m_branch" required onchange="autoFillTarget('m_branch', 'm_target')">
                    <option value="">Select Branch</option>
                    <option value="Crispy Chicken Hamdan">Hamdan</option>
                    <option value="Crispy Chicken Shabia">Shabia</option>
                    <option value="Crispy Chicken Khaldia">Khaldia</option>
                    <option value="Crispy Chicken Mourror">Mourror</option>
                    <option value="Crispy Chicken Barsha">Barsha</option>
                    <option value="Crispy Chicken Satwa">Satwa</option>
                    <option value="Crispy Chicken Electra">Electra</option>
                    <option value="Crispy Chicken Rigga">Rigga</option>
                    <option value="Crispy Chicken Majaz">Majaz</option>
                    <option value="Crispy Chicken Call Center">Call Center</option>
                </select>
            </div>
            <div class="form-group"><label>Date *</label><input type="date" id="m_date" required></div>
            <div class="input-grid">
                <div class="form-group"><label>Delivery</label><input type="number" id="m_delivery" step="0.01" min="0"></div>
                <div class="form-group"><label>Online</label><input type="number" id="m_online" step="0.01" min="0"></div>
                <div class="form-group"><label>Aggregator</label><input type="number" id="m_aggregator" step="0.01" min="0"></div>
                <div class="form-group"><label>Dining</label><input type="number" id="m_dining" step="0.01" min="0"></div>
            </div>
            <div class="input-grid">
                <div class="form-group"><label>Transactions</label><input type="number" id="m_trans" min="0"></div>
                <div class="form-group"><label>Daily Target</label><input type="number" id="m_target" step="0.01" min="0"></div>
            </div>
            <div class="modal-footer" style="border-top:1px solid #eee; padding-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                <button type="button" class="secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="success">Save</button>
            </div>
        </form>
    </div>
</div>

<div class="toast" id="toast"><i class="fas fa-info-circle"></i> <span id="toastMsg">Message</span></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- CONFIGURATION & DATA ---
const STORAGE_KEY = 'crispy_sales_v5';
let salesData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let chartInstances = {};

// Targets provided by user (Including Call Center)
const BRANCH_TARGETS = {
    "Crispy Chicken Hamdan": 27097,
    "Crispy Chicken Shabia": 25806,
    "Crispy Chicken Khaldia": 24194,
    "Crispy Chicken Mourror": 20000,
    "Crispy Chicken Barsha": 25806,
    "Crispy Chicken Satwa": 20968,
    "Crispy Chicken Electra": 32258,
    "Crispy Chicken Rigga": 26290,
    "Crispy Chicken Majaz": 12903,
    "Crispy Chicken Call Center": 8548
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('q_date').value = today;
    document.getElementById('m_date').value = today;
    updateCurrentDate();
    populateBranchFilter();
    initCharts();
    updateDashboard();
});

function updateCurrentDate() {
    document.querySelector('#currentDate span').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
}

function populateBranchFilter() {
    const select = document.getElementById('f_branch');
    while (select.options.length > 1) { select.remove(1); }
    Object.keys(BRANCH_TARGETS).forEach(branch => {
        const opt = document.createElement('option');
        opt.value = branch;
        opt.textContent = branch.replace('Crispy Chicken ', '');
        select.appendChild(opt);
    });
}

function autoFillTarget(branchSelectId, targetInputId) {
    const branchVal = document.getElementById(branchSelectId).value;
    const targetInput = document.getElementById(targetInputId);
    if (branchVal && BRANCH_TARGETS[branchVal] !== undefined) {
        targetInput.value = BRANCH_TARGETS[branchVal];
    } else {
        targetInput.value = 0;
    }
}

// --- CORE LOGIC ---
function updateDashboard() {
    const filtered = getFilteredData();
    renderKPIs(filtered);
    renderTable(filtered);
    updateCharts(filtered);
    
    const table = document.getElementById('dataTable');
    const empty = document.getElementById('emptyState');
    table.style.display = filtered.length ? 'table' : 'none';
    empty.style.display = filtered.length ? 'none' : 'block';
}

function getFilteredData() {
    const branch = document.getElementById('f_branch').value;
    const period = document.getElementById('f_period').value;
    const today = new Date();
    today.setHours(0,0,0,0);

    return salesData.filter(item => {
        let dateMatch = true;
        const itemDate = new Date(item.date);
        itemDate.setHours(0,0,0,0);

        if (period === 'today') dateMatch = itemDate.getTime() === today.getTime();
        else if (period === 'week') {
            const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7);
            dateMatch = itemDate >= weekAgo;
        }
        else if (period === 'month') {
            dateMatch = itemDate.getMonth() === today.getMonth() && itemDate.getFullYear() === today.getFullYear();
        }
        
        return dateMatch && (branch === 'all' || item.branch === branch);
    }).sort((a, b) => new Date(b.date) - new Date(a.date));
}

// --- RENDERING ---
function renderKPIs(data) {
    const totalSales = data.reduce((sum, i) => sum + i.total, 0);
    const totalTrans = data.reduce((sum, i) => sum + i.transactions, 0);
    const totalTarget = data.reduce((sum, i) => sum + i.target, 0);
    const achievement = totalTarget ? Math.round((totalSales/totalTarget)*100) : 0;

    // Calculate Call Center Aggregate (Sum of Delivery from ALL branches)
    const totalDelivery = data.reduce((sum, i) => sum + i.delivery, 0);
    const callCenterTarget = 8548; // Daily target as requested
    const callCenterAch = Math.round((totalDelivery / callCenterTarget) * 100);

    document.getElementById('kpiSection').innerHTML = `
        <div class="kpi-card aggregate">
            <i class="fas fa-headset kpi-icon"></i>
            <div class="kpi-title">Call Center (Delivery Agg.)</div>
            <div class="kpi-value" style="color:var(--warning-color)">AED ${totalDelivery.toLocaleString()}</div>
            <div class="kpi-sub">
                <strong>${callCenterAch}%</strong> of Target (8,548)
            </div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-coins kpi-icon"></i>
            <div class="kpi-title">Total Sales</div>
            <div class="kpi-value">AED ${totalSales.toLocaleString()}</div>
            <div class="kpi-sub">${data.length} records</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-receipt kpi-icon"></i>
            <div class="kpi-title">Transactions</div>
            <div class="kpi-value">${totalTrans.toLocaleString()}</div>
            <div class="kpi-sub">Total orders</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-bullseye kpi-icon"></i>
            <div class="kpi-title">Total Achievement</div>
            <div class="kpi-value" style="color:${achievement>=100?'var(--success-color)':'var(--primary-color)'}">${achievement}%</div>
            <div class="kpi-sub">Target: AED ${totalTarget.toLocaleString()}</div>
        </div>
    `;
}

function renderTable(data) {
    document.getElementById('tableBody').innerHTML = data.map(item => {
        const pct = item.target ? Math.round((item.total/item.target)*100) : 0;
        return `
        <tr>
            <td>${new Date(item.date).toLocaleDateString()}</td>
            <td><strong>${item.branch.replace('Crispy Chicken ', '')}</strong></td>
            <td>AED ${item.total.toLocaleString()}</td>
            <td>${item.transactions}</td>
            <td><span style="padding:2px 8px; border-radius:10px; background:${pct>=100?'#d1fae5':'#fee2e2'}; color:${pct>=100?'#065f46':'#991b1b'}; font-size:0.8rem; font-weight:bold;">${pct}%</span></td>
            <td style="text-align: right;">
                <button class="outline" style="padding:5px 10px;" onclick="editEntry(${item.id})"><i class="fas fa-edit"></i></button>
                <button class="danger" style="padding:5px 10px;" onclick="deleteEntry(${item.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

// --- FORM HANDLING ---
function getFormData(prefix) {
    const d = parseFloat(document.getElementById(`${prefix}_delivery`).value)||0;
    const o = parseFloat(document.getElementById(`${prefix}_online`).value)||0;
    const a = parseFloat(document.getElementById(`${prefix}_aggregator`).value)||0;
    const di = parseFloat(document.getElementById(`${prefix}_dining`).value)||0;
    const total = d+o+a+di;
    const trans = parseInt(document.getElementById(`${prefix}_trans`).value)||0;
    
    return {
        id: Date.now(),
        branch: document.getElementById(`${prefix}_branch`).value,
        date: document.getElementById(`${prefix}_date`).value,
        delivery: d, online: o, aggregator: a, dining: di,
        total,
        transactions: trans,
        target: parseFloat(document.getElementById(`${prefix}_target`).value)||0
    };
}

function handleQuickSubmit(e) {
    e.preventDefault();
    salesData.push(getFormData('q'));
    persist();
    e.target.reset();
    document.getElementById('q_date').valueAsDate = new Date();
    showToast('Entry added!');
}

function handleModalSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('m_id').value;
    const entry = getFormData('m');

    if(id) {
        entry.id = parseInt(id);
        const idx = salesData.findIndex(i => i.id === entry.id);
        if(idx > -1) salesData[idx] = entry;
    } else {
        salesData.push(entry);
    }
    persist();
    closeModal();
}

function persist() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(salesData));
    updateDashboard();
}

function editEntry(id) {
    const item = salesData.find(i => i.id === id);
    if(!item) return;
    document.getElementById('m_id').value = item.id;
    document.getElementById('m_branch').value = item.branch;
    document.getElementById('m_date').value = item.date;
    document.getElementById('m_delivery').value = item.delivery;
    document.getElementById('m_online').value = item.online;
    document.getElementById('m_aggregator').value = item.aggregator;
    document.getElementById('m_dining').value = item.dining;
    document.getElementById('m_trans').value = item.transactions;
    document.getElementById('m_target').value = item.target;
    document.getElementById('modalTitle').textContent = 'Edit Entry';
    document.getElementById('entryModal').classList.add('show');
}

function deleteEntry(id) {
    if(confirm('Delete this entry?')) {
        salesData = salesData.filter(i => i.id !== id);
        persist();
        showToast('Deleted', 'error');
    }
}

// --- CHARTS ---
function initCharts() {
    const trendCtx = document.getElementById('salesTrendChart').getContext('2d');
    chartInstances.trend = new Chart(trendCtx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    const distCtx = document.getElementById('distChart').getContext('2d');
    chartInstances.dist = new Chart(distCtx, {
        type: 'doughnut',
        data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function updateCharts(data) {
    // Trend
    const days = parseInt(document.getElementById('trendPeriod').value);
    const dateMap = {};
    for(let i=days-1; i>=0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        dateMap[d.toISOString().split('T')[0]] = 0;
    }
    data.forEach(d => { if(dateMap[d.date] !== undefined) dateMap[d.date] += d.total; });
    
    chartInstances.trend.data.labels = Object.keys(dateMap).sort();
    chartInstances.trend.data.datasets = [{ label: 'Sales', data: Object.keys(dateMap).sort().map(k => dateMap[k]), borderColor: '#b30000', tension: 0.4, fill: true }];
    chartInstances.trend.update();

    // Dist
    const totals = { delivery:0, online:0, aggregator:0, dining:0 };
    data.forEach(d => { totals.delivery += d.delivery; totals.online += d.online; totals.aggregator += d.aggregator; totals.dining += d.dining; });
    chartInstances.dist.data.labels = Object.keys(totals).map(k=>k.toUpperCase());
    chartInstances.dist.data.datasets = [{ data: Object.values(totals), backgroundColor: ['#b30000', '#e63946', '#457b9d', '#e9c46a'] }];
    chartInstances.dist.update();
}

// --- UI HELPERS ---
function openModal() {
    document.getElementById('modalForm').reset();
    document.getElementById('m_id').value = '';
    document.getElementById('m_date').valueAsDate = new Date();
    document.getElementById('modalTitle').textContent = 'Add New Entry';
    document.getElementById('entryModal').classList.add('show');
}
function closeModal() { document.getElementById('entryModal').classList.remove('show'); }
function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.style.borderLeft = type === 'success' ? '5px solid #2a9d8f' : '5px solid #e76f51';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function exportSalesData() {
    if(!salesData.length) return showToast('No data', 'error');
    const csv = 'ID,Date,Branch,Delivery,Online,Aggregator,Dining,Total,Trans,Target\n' + 
    salesData.map(i=>`${i.id},${i.date},"${i.branch}",${i.delivery},${i.online},${i.aggregator},${i.dining},${i.total},${i.transactions},${i.target}`).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='crispy_export.csv'; a.click();
}
function importSalesData(input) {
    const r = new FileReader(); r.onload=e=>{
        const rows = e.target.result.split('\n').slice(1);
        rows.forEach(row=>{
            const c = row.split(',');
            if(c.length>5) {
                salesData.push({
                    id: Date.now()+Math.random(),
                    date: c[1], branch: c[2].replace(/"/g,''),
                    delivery: parseFloat(c[3])||0, online: parseFloat(c[4])||0, aggregator: parseFloat(c[5])||0, dining: parseFloat(c[6])||0,
                    total: parseFloat(c[7])||0, transactions: parseInt(c[8])||0, target: parseFloat(c[9])||0
                });
            }
        });
        persist(); showToast('Imported');
    }; r.readAsText(input.files[0]);
}
</script>
</body>
</html>
