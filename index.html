<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crispy Chicken - Professional Performance</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary-color: #b30000;
    --primary-dark: #8a0000;
    --secondary-color: #e63946;
    --dark-color: #1d3557;
    --success-color: #2a9d8f;
    --warning-color: #e9c46a;
    --danger-color: #e76f51;
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh; color: #333; padding-bottom: 40px;
}

.container { max-width: 1800px; margin: 0 auto; padding: 20px; }

/* Header */
header {
    background: white; padding: 20px 30px; border-radius: var(--border-radius);
    margin-bottom: 25px; box-shadow: var(--shadow-lg);
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    border-bottom: 4px solid var(--primary-color);
}

h1 { color: var(--primary-color); font-size: 1.8rem; display: flex; align-items: center; gap: 12px; }
.header-actions { display: flex; gap: 10px; align-items: center; }
.date-display { color: var(--dark-color); font-weight: 500; background: #f0f2f5; padding: 8px 15px; border-radius: 20px; font-size: 0.95rem; }

/* Buttons */
button {
    padding: 10px 18px; background: var(--primary-color); color: white;
    border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
    transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
}
button:hover { background: var(--primary-dark); transform: translateY(-2px); }
button.secondary { background: var(--dark-color); }
button.success { background: var(--success-color); }
button.danger { background: var(--danger-color); }
button.outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
button.outline:hover { background: var(--primary-color); color: white; }

/* Layout */
.dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; margin-bottom: 25px; }

/* KPI Cards */
.kpi-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
.kpi-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); position: relative; }
.kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.kpi-title { font-size: 0.85rem; color: #6b7280; font-weight: 600; text-transform: uppercase; }
.kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--dark-color); margin: 10px 0; }
.kpi-sub { font-size: 0.85rem; color: #888; }
.kpi-icon { position: absolute; right: 20px; top: 20px; opacity: 0.1; font-size: 3rem; color: var(--primary-color); }

.kpi-card.aggregate { border: 2px solid var(--warning-color); background: #fffdf5; }
.kpi-card.aggregate .kpi-icon { color: var(--warning-color); }

/* Charts */
.charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
.chart-card { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
h2 { font-size: 1.2rem; color: var(--dark-color); display: flex; align-items: center; gap: 10px; }
.chart-container { position: relative; height: 300px; width: 100%; }

/* Forms */
.data-entry-panel { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); height: fit-content; }
.data-list-panel { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
.form-group { margin-bottom: 15px; }
label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--dark-color); font-size: 0.9rem; }
input, select {
    width: 100%; padding: 10px 12px;
    border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;
    transition: var(--transition); background: #f9fafb;
}
input:focus, select:focus { border-color: var(--primary-color); background: white; outline: none; }
.input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }

input.auto-calc { border-color: var(--success-color); background-color: #f0fff4; cursor: pointer; }
input.auto-calc:hover { background-color: #d1fae5; }
input.auto-calc:focus { background-color: white; }

/* Table */
.table-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end; }
.data-table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb; }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th { background: var(--dark-color); color: white; padding: 14px 16px; text-align: left; }
td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
tr:hover { background: #f9fafb; }

#dateRangeInputs {
    display: none; flex:1; gap: 10px; animation: fadeIn 0.3s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Modal */
.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: flex; justify-content: center; align-items: center; z-index: 1000;
    opacity: 0; visibility: hidden; transition: var(--transition);
}
.modal.show { opacity: 1; visibility: visible; }
.modal-content {
    background: white; padding: 30px; border-radius: var(--border-radius);
    width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    transform: scale(0.95); transition: var(--transition);
}
.modal.show .modal-content { transform: scale(1); }

/* Toast */
.toast {
    position: fixed; bottom: 30px; right: 30px;
    background: var(--dark-color); color: white;
    padding: 15px 25px; border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    transform: translateY(100px); opacity: 0; transition: var(--transition); z-index: 2000;
}
.toast.show { transform: translateY(0); opacity: 1; }

/* --- NEW PERFORMANCE SECTION STYLES --- */
.performance-section {
    background: white; padding: 25px; border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg); margin-bottom: 25px;
}

.rank-table {
    width: 100%; border-collapse: collapse; font-size: 0.95rem;
    margin-bottom: 30px;
}
.rank-table th {
    background: #2c3e50; color: white; padding: 15px; text-align: left;
    font-weight: 600;
}
.rank-table td {
    padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle;
}

.rank-badge {
    display: inline-flex; justify-content: center; align-items: center;
    width: 35px; height: 35px; border-radius: 50%;
    font-weight: bold; color: white;
    background: #ccc;
}
.rank-1 { background: #FFD700; box-shadow: 0 0 10px #FFD700; } /* Gold */
.rank-2 { background: #C0C0C0; } /* Silver */
.rank-3 { background: #CD7F32; } /* Bronze */

.status-badge {
    padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
}
.status-top { background: #d1fae5; color: #065f46; }
.status-ok { background: #e0f2fe; color: #1e40af; }
.status-low { background: #fee2e2; color: #991b1b; }

@media (max-width: 1200px) {
    .dashboard-grid { grid-template-columns: 1fr; }
    .charts-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-drumstick-bite"></i> Crispy Chicken Analytics</h1>
        <div class="header-actions">
            <div class="date-display" id="currentDate"><i class="far fa-calendar-alt"></i> <span>--</span></div>
            <button class="outline" onclick="document.getElementById('csvInput').click()"><i class="fas fa-file-upload"></i> Import CSV</button>
            <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="importSalesData(this)">
            <button class="secondary" onclick="exportSalesData()"><i class="fas fa-download"></i> Export</button>
            <button class="success" onclick="openModal()"><i class="fas fa-plus"></i> New Entry</button>
        </div>
    </header>

    <section class="kpi-section" id="kpiSection"></section>

    <section class="charts-row">
        <div class="chart-card">
            <div class="card-header">
                <h2><i class="fas fa-chart-area"></i> Sales Trend</h2>
                <select id="trendPeriod" onchange="updateDashboard()">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last Quarter</option>
                </select>
            </div>
            <div class="chart-container"><canvas id="salesTrendChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="card-header">
                <h2><i class="fas fa-chart-pie"></i> Channels</h2>
            </div>
            <div class="chart-container"><canvas id="distChart"></canvas></div>
        </div>
    </section>

    <!-- NEW PROFESSIONAL PERFORMANCE SECTION -->
    <section class="performance-section" id="performanceSection">
        <div class="card-header">
            <h2><i class="fas fa-trophy"></i> Branch Performance Ranking</h2>
            <div style="font-size:0.9rem; color:#666;">Based on selected time period</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="data-table-wrapper">
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th>Branch</th>
                            <th style="text-align: right;">Target</th>
                            <th style="text-align: right;">Actual</th>
                            <th style="text-align: center;">Ach.</th>
                            <th style="text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="rankTableBody"></tbody>
                </table>
            </div>
            <div class="chart-card" style="margin-bottom: 0;">
                <div class="card-header" style="margin-bottom: 10px;">
                    <h2 style="font-size: 1rem;">Target vs Actual</h2>
                </div>
                <div class="chart-container" style="height: 300px;"><canvas id="performanceChart"></canvas></div>
            </div>
        </div>
    </section>
    <!-- END PERFORMANCE SECTION -->

    <main class="dashboard-grid">
        <!-- Quick Entry -->
        <aside class="data-entry-panel">
            <div class="card-header"><h2><i class="fas fa-edit"></i> Quick Entry</h2></div>
            <form id="quickForm" onsubmit="handleQuickSubmit(event)">
                <div class="form-group">
                    <label>Branch *</label>
                    <select id="q_branch" required onchange="updateCalculatedTarget('q_branch', 'q_date', 'q_target')">
                        <option value="">Select Branch</option>
                        <option value="Crispy Chicken Hamdan">Hamdan St</option>
                        <option value="Crispy Chicken Shabiya">Shabiya 11</option>
                        <option value="Crispy Chicken Khaldia">Khaldia</option>
                        <option value="Crispy Chicken Muroor">Muroor</option>
                        <option value="Crispy Chicken Al Barsha">Al Barsha</option>
                        <option value="Crispy Chicken Al Satwa">Al Satwa</option>
                        <option value="Crispy Chicken ELctria">ELctria</option>
                        <option value="Crispy Chicken Al Rgga">Al Rgga</option>
                        <option value="Crispy Chicken Majaz">Majaz</option>
                        <option value="Crispy Chicken Call Center">Call Center</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="q_date" required onchange="updateCalculatedTarget('q_branch', 'q_date', 'q_target')">
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Delivery</label><input type="number" id="q_delivery" step="0.01" min="0" placeholder="0.00"></div>
                    <div class="form-group"><label>Online</label><input type="number" id="q_online" step="0.01" min="0" placeholder="0.00"></div>
                    <div class="form-group"><label>Aggregator</label><input type="number" id="q_aggregator" step="0.01" min="0" placeholder="0.00"></div>
                    <div class="form-group"><label>Dining</label><input type="number" id="q_dining" step="0.01" min="0" placeholder="0.00"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Transactions</label><input type="number" id="q_trans" min="0" placeholder="0"></div>
                    <div class="form-group">
                        <label>Daily Target</label>
                        <input type="number" id="q_target" step="0.01" class="auto-calc" placeholder="Auto-calc..." title="Auto-calculated (You can edit)">
                    </div>
                </div>
                <button type="submit" class="success" style="width: 100%; justify-content: center;"><i class="fas fa-save"></i> Save Entry</button>
            </form>
        </aside>

        <!-- Table -->
        <section class="data-list-panel">
            <div class="card-header"><h2><i class="fas fa-table"></i> Transaction History</h2></div>
            <div class="table-controls">
                <div class="filter-group" style="flex:1; min-width:180px;">
                    <label>Filter Branch</label>
                    <select id="f_branch" onchange="updateDashboard()"><option value="all">All Branches</option></select>
                </div>
                <div class="filter-group" style="flex:1; min-width:150px;">
                    <label>Time Period</label>
                    <select id="f_period" onchange="toggleDateInputs(); updateDashboard()">
                        <option value="today">Daily (Today)</option>
                        <option value="week">Weekly (Last 7 Days)</option>
                        <option value="month">Monthly (Last 30 Days)</option>
                        <option value="custom">Day To Day (Custom Range)</option>
                    </select>
                </div>
                <div id="dateRangeInputs">
                    <div style="flex:1;"><label>Start Date</label><input type="date" id="f_start" onchange="updateDashboard()"></div>
                    <div style="flex:1;"><label>End Date</label><input type="date" id="f_end" onchange="updateDashboard()"></div>
                </div>
            </div>
            <div class="data-table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Branch</th>
                            <th>Total</th>
                            <th>Trans.</th>
                            <th>Achievement</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div id="emptyState" style="display:none; text-align: center; padding: 40px; color: #999;">
                <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <p>No records found.</p>
            </div>
        </section>
    </main>
</div>

<!-- Modal -->
<div class="modal" id="entryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Data</h2>
            <button class="outline" onclick="closeModal()" style="border:none; padding:5px;"><i class="fas fa-times"></i></button>
        </div>
        <form id="modalForm" onsubmit="handleModalSubmit(event)">
            <input type="hidden" id="m_id">
            <div class="form-group">
                <label>Branch *</label>
                <select id="m_branch" required onchange="updateCalculatedTarget('m_branch', 'm_date', 'm_target')">
                    <option value="">Select Branch</option>
                    <option value="Crispy Chicken Hamdan">Hamdan St</option>
                    <option value="Crispy Chicken Shabiya">Shabiya 11</option>
                    <option value="Crispy Chicken Khaldia">Khaldia</option>
                    <option value="Crispy Chicken Muroor">Muroor</option>
                    <option value="Crispy Chicken Al Barsha">Al Barsha</option>
                    <option value="Crispy Chicken Al Satwa">Al Satwa</option>
                    <option value="Crispy Chicken ELctria">ELctria</option>
                    <option value="Crispy Chicken Al Rgga">Al Rgga</option>
                    <option value="Crispy Chicken Majaz">Majaz</option>
                    <option value="Crispy Chicken Call Center">Call Center</option>
                </select>
            </div>
            <div class="form-group"><label>Date *</label><input type="date" id="m_date" required onchange="updateCalculatedTarget('m_branch', 'm_date', 'm_target')"></div>
            <div class="input-grid">
                <div class="form-group"><label>Delivery</label><input type="number" id="m_delivery" step="0.01" min="0"></div>
                <div class="form-group"><label>Online</label><input type="number" id="m_online" step="0.01" min="0"></div>
                <div class="form-group"><label>Aggregator</label><input type="number" id="m_aggregator" step="0.01" min="0"></div>
                <div class="form-group"><label>Dining</label><input type="number" id="m_dining" step="0.01" min="0"></div>
            </div>
            <div class="input-grid">
                <div class="form-group"><label>Transactions</label><input type="number" id="m_trans" min="0"></div>
                <div class="form-group">
                    <label>Daily Target</label>
                    <input type="number" id="m_target" step="0.01" class="auto-calc" placeholder="Auto-calc..." title="Auto-calculated (You can edit)">
                </div>
            </div>
            <div class="modal-footer" style="border-top:1px solid #eee; padding-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                <button type="button" class="secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="success">Save</button>
            </div>
        </form>
    </div>
</div>

<div class="toast" id="toast"><i class="fas fa-info-circle"></i> <span id="toastMsg">Message</span></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- CONFIGURATION & DATA ---
const STORAGE_KEY = 'crispy_sales_v13';
let salesData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let chartInstances = {};

const BRANCH_MONTHLY_TARGETS = {
    "Crispy Chicken Hamdan": 840000,
    "Crispy Chicken Shabiya": 800000,
    "Crispy Chicken Khaldia": 750000,
    "Crispy Chicken Muroor": 620000,
    "Crispy Chicken Al Barsha": 800000,
    "Crispy Chicken Al Satwa": 650000,
    "Crispy Chicken ELctria": 1000000,
    "Crispy Chicken Al Rgga": 815000,
    "Crispy Chicken Majaz": 400000,
    "Crispy Chicken Call Center": 265000
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    const todayStr = new Date().toISOString().split('T')[0];
    document.getElementById('q_date').value = todayStr;
    document.getElementById('m_date').value = todayStr;
    document.getElementById('f_start').value = todayStr;
    document.getElementById('f_end').value = todayStr;
    
    updateCurrentDate();
    populateBranchFilter();
    initCharts();
    
    updateCalculatedTarget('q_branch', 'q_date', 'q_target');
    updateDashboard();
});

function updateCurrentDate() {
    document.querySelector('#currentDate span').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
}

function populateBranchFilter() {
    const select = document.getElementById('f_branch');
    while (select.options.length > 1) { select.remove(1); }
    Object.keys(BRANCH_MONTHLY_TARGETS).forEach(branch => {
        const opt = document.createElement('option');
        opt.value = branch;
        opt.textContent = branch.replace('Crispy Chicken ', '');
        select.appendChild(opt);
    });
}

function updateCalculatedTarget(branchSelectId, dateInputId, targetInputId) {
    const branchVal = document.getElementById(branchSelectId).value;
    const dateVal = document.getElementById(dateInputId).value;
    const targetInput = document.getElementById(targetInputId);

    if (document.activeElement !== targetInput) {
        if (branchVal && dateVal && BRANCH_MONTHLY_TARGETS[branchVal]) {
            const monthlyTarget = BRANCH_MONTHLY_TARGETS[branchVal];
            const dateObj = new Date(dateVal);
            const daysInMonth = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0).getDate();
            const dailyTarget = monthlyTarget / daysInMonth;
            targetInput.value = dailyTarget.toFixed(2);
        } else {
            targetInput.value = 0;
        }
    }
}

function toggleDateInputs() {
    const type = document.getElementById('f_period').value;
    const inputs = document.getElementById('dateRangeInputs');
    inputs.style.display = (type === 'custom') ? 'flex' : 'none';
}

// --- CORE LOGIC ---
function updateDashboard() {
    const filtered = getFilteredData();
    renderKPIs(filtered);
    renderTable(filtered);
    renderPerformanceBoard(filtered); // NEW: Render Ranking
    updateCharts(filtered);
    
    const table = document.getElementById('dataTable');
    const empty = document.getElementById('emptyState');
    table.style.display = filtered.length ? 'table' : 'none';
    empty.style.display = filtered.length ? 'none' : 'block';
}

function getFilteredData() {
    const branch = document.getElementById('f_branch').value;
    const period = document.getElementById('f_period').value;
    const today = new Date();
    today.setHours(0,0,0,0);

    return salesData.filter(item => {
        let dateMatch = true;
        const itemDate = new Date(item.date);
        itemDate.setHours(0,0,0,0);

        if (period === 'today') {
            dateMatch = itemDate.getTime() === today.getTime();
        } else if (period === 'week') {
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            dateMatch = itemDate >= weekAgo;
        } else if (period === 'month') {
            const monthAgo = new Date(today);
            monthAgo.setDate(today.getDate() - 30);
            dateMatch = itemDate >= monthAgo;
        } else if (period === 'custom') {
            const startVal = document.getElementById('f_start').value;
            const endVal = document.getElementById('f_end').value;
            if(startVal && endVal) {
                const start = new Date(startVal); start.setHours(0,0,0,0);
                const end = new Date(endVal); end.setHours(0,0,0,0);
                dateMatch = itemDate >= start && itemDate <= end;
            } else {
                dateMatch = false;
            }
        }
        return dateMatch && (branch === 'all' || item.branch === branch);
    }).sort((a, b) => new Date(b.date) - new Date(a.date));
}

// --- RENDERING KPI ---
function renderKPIs(data) {
    const totalSales = data.reduce((sum, i) => sum + i.total, 0);
    const totalTrans = data.reduce((sum, i) => sum + i.transactions, 0);
    const totalTarget = data.reduce((sum, i) => sum + i.target, 0);
    const achievement = totalTarget ? Math.round((totalSales/totalTarget)*100) : 0;

    const totalDelivery = data.reduce((sum, i) => sum + i.delivery, 0);
    
    // Call Center Logic
    let selectedDays = 1;
    const period = document.getElementById('f_period').value;
    if (period === 'today') selectedDays = 1;
    else if (period === 'week') selectedDays = 7;
    else if (period === 'month') selectedDays = 31;
    else if (period === 'custom') {
        const startVal = document.getElementById('f_start').value;
        const endVal = document.getElementById('f_end').value;
        if(startVal && endVal) {
            const start = new Date(startVal);
            const end = new Date(endVal);
            const diffTime = Math.abs(end - start);
            selectedDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }
    }

    const callCenterMonthlyTarget = 265000;
    const callCenterDailyTarget = callCenterMonthlyTarget / 31;
    const kpiCallCenterTarget = callCenterDailyTarget * selectedDays;
    const callCenterAch = kpiCallCenterTarget ? Math.round((totalDelivery / kpiCallCenterTarget) * 100) : 0;

    document.getElementById('kpiSection').innerHTML = `
        <div class="kpi-card aggregate">
            <i class="fas fa-headset kpi-icon"></i>
            <div class="kpi-title">Call Center (Delivery Agg.)</div>
            <div class="kpi-value" style="color:var(--warning-color)">AED ${totalDelivery.toLocaleString()}</div>
            <div class="kpi-sub"><strong>${callCenterAch}%</strong> (Target: AED ${kpiCallCenterTarget.toLocaleString(undefined, {maximumFractionDigits:0})})</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-coins kpi-icon"></i>
            <div class="kpi-title">Total Sales</div>
            <div class="kpi-value">AED ${totalSales.toLocaleString()}</div>
            <div class="kpi-sub">${data.length} records</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-receipt kpi-icon"></i>
            <div class="kpi-title">Transactions</div>
            <div class="kpi-value">${totalTrans.toLocaleString()}</div>
            <div class="kpi-sub">Total orders</div>
        </div>
        <div class="kpi-card">
            <i class="fas fa-bullseye kpi-icon"></i>
            <div class="kpi-title">Total Achievement</div>
            <div class="kpi-value" style="color:${achievement>=100?'var(--success-color)':'var(--primary-color)'}">${achievement}%</div>
            <div class="kpi-sub">Target: AED ${totalTarget.toLocaleString()}</div>
        </div>
    `;
}

// --- NEW: RENDER PROFESSIONAL PERFORMANCE BOARD ---
function renderPerformanceBoard(data) {
    if(data.length === 0) {
        document.getElementById('rankTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;">No data for this period</td></tr>';
        return;
    }

    // Aggregate by branch
    const branchStats = {};
    data.forEach(item => {
        if (!branchStats[item.branch]) {
            branchStats[item.branch] = { sales: 0, target: 0, trans: 0 };
        }
        branchStats[item.branch].sales += item.total;
        branchStats[item.branch].target += item.target;
        branchStats[item.branch].trans += item.transactions;
    });

    // Convert to array and calculate achievements
    const ranking = Object.keys(branchStats).map(branch => {
        const stats = branchStats[branch];
        const ach = stats.target ? (stats.sales / stats.target) * 100 : 0;
        let status = 'status-ok';
        let label = 'On Track';
        
        if (ach >= 100) { status = 'status-top'; label = 'Top Performer'; }
        else if (ach < 90) { status = 'status-low'; label = 'Needs Action'; }
        else { label = 'On Track'; }

        return {
            branch,
            sales: stats.sales,
            target: stats.target,
            ach: ach.toFixed(1),
            statusClass: status,
            statusLabel: label
        };
    });

    // Sort by Achievement (High to Low)
    ranking.sort((a, b) => parseFloat(b.ach) - parseFloat(a.ach));

    // Render Table
    document.getElementById('rankTableBody').innerHTML = ranking.map((r, index) => `
        <tr>
            <td><span class="rank-badge rank-${index+1}">${index + 1}</span></td>
            <td><strong>${r.branch.replace('Crispy Chicken ', '')}</strong></td>
            <td style="text-align: right;">AED ${r.target.toLocaleString()}</td>
            <td style="text-align: right; font-weight:bold; color:var(--primary-color)">AED ${r.sales.toLocaleString()}</td>
            <td style="text-align: center; font-weight:bold;">${r.ach}%</td>
            <td style="text-align: center;"><span class="status-badge ${r.statusClass}">${r.statusLabel}</span></td>
        </tr>
    `).join('');

    updatePerformanceChart(ranking);
}

function updatePerformanceChart(rankingData) {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    if(!chartInstances.perf) {
        chartInstances.perf = new Chart(ctx, {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    chartInstances.perf.data.labels = rankingData.map(r => r.branch.replace('Crispy Chicken ', ''));
    chartInstances.perf.data.datasets = [
        {
            label: 'Target',
            data: rankingData.map(r => r.target),
            backgroundColor: '#e2e8f0',
            borderRadius: 4
        },
        {
            label: 'Actual Sales',
            data: rankingData.map(r => r.sales),
            backgroundColor: (ctx) => {
                const value = ctx.raw;
                const target = ctx.chart.data.datasets[0].data[ctx.dataIndex];
                return value >= target ? '#2a9d8f' : '#e76f51';
            },
            borderRadius: 4
        }
    ];
    chartInstances.perf.update();
}

function renderTable(data) {
    document.getElementById('tableBody').innerHTML = data.map(item => {
        const pct = item.target ? Math.round((item.total/item.target)*100) : 0;
        return `
        <tr>
            <td>${new Date(item.date).toLocaleDateString()}</td>
            <td><strong>${item.branch.replace('Crispy Chicken ', '')}</strong></td>
            <td>AED ${item.total.toLocaleString()}</td>
            <td>${item.transactions}</td>
            <td><span style="padding:2px 8px; border-radius:10px; background:${pct>=100?'#d1fae5':'#fee2e2'}; color:${pct>=100?'#065f46':'#991b1b'}; font-size:0.8rem; font-weight:bold;">${pct}%</span></td>
            <td style="text-align: right;">
                <button class="outline" style="padding:5px 10px;" onclick="editEntry(${item.id})"><i class="fas fa-edit"></i></button>
                <button class="danger" style="padding:5px 10px;" onclick="deleteEntry(${item.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

// --- FORM HANDLING ---
function getFormData(prefix) {
    const d = parseFloat(document.getElementById(`${prefix}_delivery`).value)||0;
    const o = parseFloat(document.getElementById(`${prefix}_online`).value)||0;
    const a = parseFloat(document.getElementById(`${prefix}_aggregator`).value)||0;
    const di = parseFloat(document.getElementById(`${prefix}_dining`).value)||0;
    const total = d+o+a+di;
    const trans = parseInt(document.getElementById(`${prefix}_trans`).value)||0;
    
    return {
        id: Date.now(),
        branch: document.getElementById(`${prefix}_branch`).value,
        date: document.getElementById(`${prefix}_date`).value,
        delivery: d, online: o, aggregator: a, dining: di,
        total,
        transactions: trans,
        target: parseFloat(document.getElementById(`${prefix}_target`).value)||0
    };
}

function handleQuickSubmit(e) {
    e.preventDefault();
    salesData.push(getFormData('q'));
    persist();
    e.target.reset();
    document.getElementById('q_date').valueAsDate = new Date();
    showToast('Entry added!');
}

function handleModalSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('m_id').value;
    const entry = getFormData('m');

    if(id) {
        entry.id = parseInt(id);
        const idx = salesData.findIndex(i => i.id === entry.id);
        if(idx > -1) salesData[idx] = entry;
    } else {
        salesData.push(entry);
    }
    persist();
    closeModal();
}

function persist() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(salesData));
    updateDashboard();
}

function editEntry(id) {
    const item = salesData.find(i => i.id === id);
    if(!item) return;
    document.getElementById('m_id').value = item.id;
    document.getElementById('m_branch').value = item.branch;
    document.getElementById('m_date').value = item.date;
    document.getElementById('m_delivery').value = item.delivery;
    document.getElementById('m_online').value = item.online;
    document.getElementById('m_aggregator').value = item.aggregator;
    document.getElementById('m_dining').value = item.dining;
    document.getElementById('m_trans').value = item.transactions;
    document.getElementById('m_target').value = item.target;
    document.getElementById('modalTitle').textContent = 'Edit Entry';
    document.getElementById('entryModal').classList.add('show');
}

function deleteEntry(id) {
    if(confirm('Delete this entry?')) {
        salesData = salesData.filter(i => i.id !== id);
        persist();
        showToast('Deleted', 'error');
    }
}

// --- CHARTS ---
function initCharts() {
    const trendCtx = document.getElementById('salesTrendChart').getContext('2d');
    chartInstances.trend = new Chart(trendCtx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    const distCtx = document.getElementById('distChart').getContext('2d');
    chartInstances.dist = new Chart(distCtx, {
        type: 'doughnut',
        data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function updateCharts(data) {
    const days = parseInt(document.getElementById('trendPeriod').value);
    const dateMap = {};
    for(let i=days-1; i>=0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        dateMap[d.toISOString().split('T')[0]] = 0;
    }
    data.forEach(d => { if(dateMap[d.date] !== undefined) dateMap[d.date] += d.total; });
    
    chartInstances.trend.data.labels = Object.keys(dateMap).sort();
    chartInstances.trend.data.datasets = [{ label: 'Sales', data: Object.keys(dateMap).sort().map(k => dateMap[k]), borderColor: '#b30000', tension: 0.4, fill: true }];
    chartInstances.trend.update();

    const totals = { delivery:0, online:0, aggregator:0, dining:0 };
    data.forEach(d => { totals.delivery += d.delivery; totals.online += d.online; totals.aggregator += d.aggregator; totals.dining += d.dining; });
    chartInstances.dist.data.labels = Object.keys(totals).map(k=>k.toUpperCase());
    chartInstances.dist.data.datasets = [{ data: Object.values(totals), backgroundColor: ['#b30000', '#e63946', '#457b9d', '#e9c46a'] }];
    chartInstances.dist.update();
}

// --- IMPORT/EXPORT HELPERS ---
function openModal() {
    document.getElementById('modalForm').reset();
    document.getElementById('m_id').value = '';
    document.getElementById('m_date').valueAsDate = new Date();
    document.getElementById('modalTitle').textContent = 'Add New Entry';
    document.getElementById('entryModal').classList.add('show');
}
function closeModal() { document.getElementById('entryModal').classList.remove('show'); }
function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.style.borderLeft = type === 'success' ? '5px solid #2a9d8f' : '5px solid #e76f51';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function exportSalesData() {
    if(!salesData.length) return showToast('No data', 'error');
    const csv = 'ID,Date,Branch,Delivery,Online,Aggregator,Dining,Total,Trans,Target\n' + 
    salesData.map(i=>`${i.id},${i.date},"${i.branch}",${i.delivery},${i.online},${i.aggregator},${i.dining},${i.total},${i.transactions},${i.target}`).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='crispy_export.csv'; a.click();
}

function importSalesData(input) {
    const r = new FileReader();
    r.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n');
        const dataRows = rows.slice(1);
        
        dataRows.forEach(row => {
            const separator = row.includes('\t') ? '\t' : ',';
            const c = row.split(separator);
            if(c.length >= 2) {
                const clean = (str) => str ? str.replace(/"/g, '') : '';
                salesData.push({
                    id: parseFloat(c[0]) || Date.now(),
                    date: clean(c[1]), 
                    branch: clean(c[2]),
                    delivery: parseFloat(c[3])||0, 
                    online: parseFloat(c[4])||0, 
                    aggregator: parseFloat(c[5])||0, 
                    dining: parseFloat(c[6])||0,
                    total: parseFloat(c[7])||0, 
                    transactions: parseInt(c[8])||0, 
                    target: parseFloat(c[9])||0
                });
            }
        });
        persist(); 
        showToast(`Imported ${dataRows.length} records`);
    };
    r.readAsText(input.files[0]);
}
</script>
</body>
</html>
